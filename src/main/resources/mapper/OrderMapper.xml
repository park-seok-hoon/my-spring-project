<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.minishop.repository.mybatis.mapper.OrderMapper">

    <!-- 주문 저장 -->
    <insert id="insertOrder" parameterType="Orders" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO orders (user_id, order_date, total_price)
        VALUES (#{userId}, #{orderDate}, #{totalPrice})
    </insert>

    <!-- 주문상품 저장 -->
    <insert id="insertOrderItem" parameterType="OrderItems">
        INSERT INTO order_items (order_id, item_id, quantity)
        VALUES (#{orderId}, #{itemId}, #{quantity})
    </insert>

    <!-- 주문 단건 조회 -->
    <select id="findById" resultType="Orders">
        SELECT
        order_id AS id,
        user_id AS userId,
        order_date AS orderDate,
        total_price AS totalPrice,
        status
        FROM orders
        WHERE order_id = #{orderId}
    </select>


    <!-- 전체 주문 조회 -->
    <select id="findAll" resultType="Orders">
        SELECT
        order_id AS id,
        user_id AS userId,
        order_date AS orderDate,
        total_price AS totalPrice,
        status
        FROM orders
        ORDER BY order_id DESC
    </select>

    <!-- 주문 상태 변경 -->
    <update id="updateOrderStatus">
        UPDATE orders
        SET status = #{status}
        WHERE order_id = #{orderId}
    </update>

    <!-- 주문 수정 -->
    <update id="updateOrder" parameterType="Orders">
        UPDATE orders
        SET
        user_id = #{userId},
        status = #{status}
        WHERE order_id = #{id}
    </update>


    <!-- 주문 + 주문상품 전체 매핑 -->
    <resultMap id="orderResultMap" type="Orders">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="orderDate" column="order_date"/>
        <result property="totalPrice" column="total_price"/>

        <!-- Orders.orderItems 필드 매핑 -->
        <collection property="orderItems"
                    ofType="com.minishop.domain.OrderItems"
                    select="findOrderItemsByOrderId"
                    column="id" />
    </resultMap>

    <!-- 주문상품 조회 -->
    <select id="findOrderItemsByOrderId" parameterType="long" resultType="OrderItems">
        SELECT * FROM order_items WHERE order_id = #{value}
    </select>

    <!-- 전체 주문 목록 -->
    <select id="findAll" resultMap="orderResultMap">
        SELECT * FROM orders ORDER BY order_date DESC
    </select>

    <!-- 주문 상태 변경 -->
    <update id="updateOrderStatus">
        UPDATE orders SET status = #{status}
        WHERE id = #{orderId}
    </update>

</mapper>
